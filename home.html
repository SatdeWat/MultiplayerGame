<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Zeeslag — Home</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
<main class="wrap">
  <div class="topbar">
    <div><h1>Zeeslag — Home</h1><div class="muted">Kies wat je wilt doen</div></div>
    <div id="profile-info" class="muted"></div>
  </div>

  <section class="card" id="profile-card">
    <div style="display:flex;gap:12px;align-items:center;justify-content:space-between">
      <div>
        <h3 id="profile-username">—</h3>
        <div class="muted" id="profile-uid"></div>
      </div>
      <div style="display:flex;gap:8px">
        <button id="btn-join-lobby">Join Lobby</button>
        <button id="btn-gamemodes">Gamemodes</button>
        <button id="btn-leaderboard">Leaderboard</button>
        <button id="btn-tutorial">How to play</button>
        <button id="btn-logout" class="ghost">Logout</button>
      </div>
    </div>
  </section>

  <section class="card hidden" id="gamemode-list">
    <h3>Gamemodes (maak lobby)</h3>
    <div class="row" style="gap:12px;align-items:center">
      <div style="flex:1">
        <h4>Classic</h4>
        <p class="muted">Iedere speler krijgt 1 beurt per ronde (wisselt altijd).</p>
        <div class="row">
          <select id="gm-classic-size"><option value="10">10×10</option><option value="15">15×15</option><option value="20">20×20</option></select>
          <button id="btn-classic-create">Create Classic</button>
        </div>
      </div>

      <div style="flex:1">
        <h4>Power</h4>
        <p class="muted">20×20. Wanneer je een schip volledig zinkt verdien je 1 <strong>powershot</strong>: reveal 3×3 blok.</p>
        <div><button id="btn-power-create">Create Power (20×20)</button></div>
      </div>

      <div style="flex:1">
        <h4>Streak</h4>
        <p class="muted">Krijg een extra beurt als je een hit scoort (hit → blijf schieten).</p>
        <div class="row">
          <select id="gm-streak-size"><option value="10">10×10</option><option value="15">15×15</option><option value="20">20×20</option></select>
          <button id="btn-streak-create">Create Streak</button>
        </div>
      </div>
    </div>
    <div style="margin-top:12px"><button id="btn-back-menu" class="ghost">Back</button></div>
  </section>
</main>

<script type="module">
import { loadLocalProfile } from "./app-auth.js";
import { db } from "./firebase-config.js";
import { ref, set } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const $ = id => document.getElementById(id);

document.addEventListener('DOMContentLoaded', ()=>{
  const profile = loadLocalProfile();
  if (!profile) { location.href = "index.html"; return; }
  $('profile-username').textContent = profile.username + (profile.guest ? ' (Gast)' : '');
  $('profile-uid').textContent = profile.uid;

  $('btn-logout').addEventListener('click', ()=> { localStorage.removeItem('zs_profile_v2'); location.href = "index.html"; });
  $('btn-join-lobby').addEventListener('click', ()=> location.href = "lobby.html");
  $('btn-leaderboard').addEventListener('click', ()=> location.href = "leaderboard.html");
  $('btn-gamemodes').addEventListener('click', ()=> $('gamemode-list').classList.toggle('hidden'));

  $('btn-tutorial').addEventListener('click', ()=> {
    const overlay = document.querySelector('.overlay');
    const html = `<div class="tutorial"><h2>How to play — overzicht</h2>
      <p>Hier een korte uitleg per gamemode:</p>
      <ul>
        <li><strong>Classic</strong> — Beurt wisselt altijd. Kies boardgrootte en plaats schepen. Klaar → start.</li>
        <li><strong>Streak</strong> — Als je een hit hebt mag je direct nog een keer schieten (handig om combo’s te maken).</li>
        <li><strong>Power</strong> — 20×20. Als je een volledig schip zinkt krijg je 1 Powershot: kies een cel voor een 3×3 reveal. Gebruik strategisch!</li>
      </ul>
      <p class="muted">Plaats je schepen handmatig of gebruik <strong>Random</strong>. Wanneer beide spelers klaar zijn begint het spel automatisch.</p>
      <div style="text-align:center"><button id="tutorial-ok">Akkoord</button></div></div>`;
    if (!overlay){
      const o = document.createElement('div'); o.className = 'overlay'; o.innerHTML = `<div class="overlay-inner">${html}<div class="overlay-actions"><button id="overlay-close">Sluit</button></div></div>`; document.body.appendChild(o);
      document.getElementById('overlay-close').addEventListener('click', ()=> o.classList.add('hidden'));
      setTimeout(()=> { document.getElementById('tutorial-ok').addEventListener('click', ()=> { o.classList.add('hidden'); localStorage.setItem('zs_tutorial_seen_v1','1'); }); }, 50);
    } else {
      overlay.classList.remove('hidden');
      document.getElementById('overlay-inner-content').innerHTML = html;
      setTimeout(()=> { const ok = document.getElementById('tutorial-ok'); if (ok) ok.onclick = ()=> { overlay.classList.add('hidden'); localStorage.setItem('zs_tutorial_seen_v1','1'); }; }, 50);
    }
  });

  function makeCode(len=6){ const chars="ABCDEFGHJKMNPQRSTUVWXYZ23456789"; let s=""; for(let i=0;i<len;i++) s+=chars[Math.floor(Math.random()*chars.length)]; return s; }

  async function createLobby(gamemode, size){
    const uid = profile.uid;
    const code = makeCode(6);
    const gameId = `game_${Date.now()}_${Math.floor(Math.random()*9999)}`;
    const players = {}; players[uid] = { username: profile.username, ready:false, slot:0 };
    await set(ref(db, `lobbies/${code}`), { gameId, owner: uid, gamemode, size });
    await set(ref(db, `games/${gameId}`), { players, status: "waiting", gamemode, size, createdAt: Date.now() });
    location.href = `lobby.html?code=${code}`;
  }

  $('btn-classic-create').addEventListener('click', ()=> createLobby('classic', parseInt($('gm-classic-size').value,10)));
  $('btn-power-create').addEventListener('click', ()=> createLobby('power', 20));
  $('btn-streak-create').addEventListener('click', ()=> createLobby('streak', parseInt($('gm-streak-size').value,10)));
});
</script>
</body>
</html>
