<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Zeeslag — Home</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
<main class="wrap">
  <header class="topbar"><h1>Zeeslag — Home</h1><p class="subtitle">Kies wat je wilt doen</p></header>

  <section class="card" id="profile-card">
    <h3>Mijn profiel</h3>
    <div id="profile-info"></div>
    <div style="margin-top:10px">
      <button id="btn-join-lobby">Join Lobby</button>
      <button id="btn-gamemodes">Gamemodes</button>
      <button id="btn-leaderboard">Leaderboard</button>
      <button id="btn-tutorial">How to play</button>
      <button id="btn-logout">Logout</button>
    </div>
  </section>

  <section class="card hidden" id="gamemode-list">
    <h3>Gamemodes (maak lobby)</h3>
    <div class="row" style="gap:12px;align-items:center">
      <div style="flex:1">
        <h4>Classic</h4>
        <div class="row">
          <select id="gm-classic-size"><option value="10">10×10</option><option value="15">15×15</option><option value="20">20×20</option></select>
          <button id="btn-classic-create">Create Classic</button>
        </div>
      </div>

      <div style="flex:1">
        <h4>Power</h4>
        <div>
          <button id="btn-power-create">Create Power (20×20)</button>
        </div>
      </div>

      <div style="flex:1">
        <h4>Streak</h4>
        <div class="row">
          <select id="gm-streak-size"><option value="10">10×10</option><option value="15">15×15</option><option value="20">20×20</option></select>
          <button id="btn-streak-create">Create Streak</button>
        </div>
      </div>
    </div>
    <div style="margin-top:10px"><button id="btn-back-menu">Back</button></div>
  </section>
</main>

<script type="module">
import { loadLocalProfile } from "./app-auth.js";
import { db } from "./firebase-config.js";
import { ref, set } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const $ = id => document.getElementById(id);

document.addEventListener('DOMContentLoaded', ()=>{
  const profile = loadLocalProfile();
  if (!profile) { location.href = "index.html"; return; }
  $('profile-info').innerHTML = `<strong>${profile.username}</strong> ${profile.guest? '(gast)':''}<div class="muted">UID: ${profile.uid}</div>`;

  $('btn-logout').addEventListener('click', ()=> { localStorage.removeItem('zs_profile_v2'); location.href = "index.html"; });
  $('btn-join-lobby').addEventListener('click', ()=> location.href = "lobby.html");
  $('btn-leaderboard').addEventListener('click', ()=> location.href = "leaderboard.html");
  $('btn-gamemodes').addEventListener('click', ()=> $('gamemode-list').classList.remove('hidden'));
  $('btn-back-menu').addEventListener('click', ()=> $('gamemode-list').classList.add('hidden'));

  $('btn-tutorial').addEventListener('click', ()=> {
    // show tutorial modal (re-uses overlay)
    const overlay = document.querySelector('.overlay');
    if (!overlay){
      const o = document.createElement('div');
      o.className = 'overlay';
      o.innerHTML = `<div class="overlay-inner"><div id="overlay-inner-content"><h2>How to play</h2><p>Place ships, click ready, then shoot.</p></div><div class="overlay-actions"><button id="overlay-close">OK</button></div></div>`;
      document.body.appendChild(o);
      document.getElementById('overlay-close').addEventListener('click', ()=> o.classList.add('hidden'));
      o.classList.remove('hidden');
    } else {
      overlay.classList.remove('hidden');
      document.getElementById('overlay-inner-content').innerHTML = `<h2>How to play</h2><ul><li>Create/join a lobby.</li><li>Place ships and click Ready.</li><li>Classic: alternate turns. Streak: hit -> extra turn. Power: sink ship -> gains powershot.</li></ul>`;
    }
  });

  function makeCode(len=6){ const chars="ABCDEFGHJKMNPQRSTUVWXYZ23456789"; let s=""; for(let i=0;i<len;i++) s+=chars[Math.floor(Math.random()*chars.length)]; return s; }

  async function createLobby(gamemode, size){
    const uid = profile.uid;
    const code = makeCode(6);
    const gameId = `game_${Date.now()}_${Math.floor(Math.random()*9999)}`;
    const players = {}; players[uid] = { username: profile.username, ready:false, slot:0 };
    await set(ref(db, `lobbies/${code}`), { gameId, owner: uid, gamemode, size });
    await set(ref(db, `games/${gameId}`), { players, status: "waiting", gamemode, size, createdAt: Date.now() });
    location.href = `lobby.html?code=${code}`;
  }

  $('btn-classic-create').addEventListener('click', ()=> createLobby('classic', parseInt($('gm-classic-size').value,10)));
  $('btn-power-create').addEventListener('click', ()=> createLobby('power', 20));
  $('btn-streak-create').addEventListener('click', ()=> createLobby('streak', parseInt($('gm-streak-size').value,10)));
});
</script>
</body>
</html>
