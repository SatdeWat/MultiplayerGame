<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Zeeslag - Home</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<div class="container">
  <h1>⚓ Zeeslag - Home ⚓</h1>
  <button id="createLobbyBtn">Maak Lobby</button>
  <button id="joinLobbyBtn">Join Lobby</button>
  <button id="leaderboardBtn">Leaderboard</button>
  <button id="logoutBtn">Logout</button>

  <div id="createLobbySection" style="display:none;">
    <h3>Kies gamemode</h3>
    <button class="modeBtn" data-mode="classic">Classic</button>
    <button class="modeBtn" data-mode="streak">Streak</button>
    <button class="modeBtn" data-mode="power">Power</button>
    <div id="sizeSelection"></div>
  </div>

  <div id="joinLobbySection" style="display:none;">
    <h3>Voer Lobby Code in</h3>
    <input type="text" id="lobbyCodeInput" placeholder="Lobby Code">
    <button id="joinLobbyConfirmBtn">Join</button>
  </div>

  <div id="lobbyScreen" style="display:none;">
    <h3>Lobby Code: <span id="lobbyCodeDisplay"></span></h3>
    <p>Jij: <span id="playerName"></span> ❌</p>
    <p>Tegenstander: <span id="opponentName">Wachten...</span> ❌</p>
    <button id="readyBtn">Klaar</button>
  </div>
</div>

<script type="module">
import { db, ref, set, get, update, onValue } from "./firebase.js";

const username = localStorage.getItem("username");
const isGuest = localStorage.getItem("isGuest") === "true";
if(!username) window.location.href="index.html";

const createLobbyBtn = document.getElementById("createLobbyBtn");
const joinLobbyBtn = document.getElementById("joinLobbyBtn");
const logoutBtn = document.getElementById("logoutBtn");

const createLobbySection = document.getElementById("createLobbySection");
const joinLobbySection = document.getElementById("joinLobbySection");
const sizeSelection = document.getElementById("sizeSelection");
const lobbyScreen = document.getElementById("lobbyScreen");
const lobbyCodeDisplay = document.getElementById("lobbyCodeDisplay");
const playerNameSpan = document.getElementById("playerName");
const opponentNameSpan = document.getElementById("opponentName");

const lobbyCodeInput = document.getElementById("lobbyCodeInput");
const joinLobbyConfirmBtn = document.getElementById("joinLobbyConfirmBtn");
const readyBtn = document.getElementById("readyBtn");

// Knoppen
createLobbyBtn.addEventListener("click", ()=>{
  createLobbySection.style.display="block";
  joinLobbySection.style.display="none";
});
joinLobbyBtn.addEventListener("click", ()=>{
  joinLobbySection.style.display="block";
  createLobbySection.style.display="none";
});
logoutBtn.addEventListener("click", ()=>{
  localStorage.clear();
  window.location.href="index.html";
});

// Gamemode select
document.querySelectorAll(".modeBtn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const mode = btn.dataset.mode;
    sizeSelection.innerHTML="";
    const sizes = [
      {size:10,ships:3},
      {size:15,ships:4},
      {size:20,ships:6}
    ];
    sizes.forEach(s=>{
      const b=document.createElement("button");
      b.textContent=`${s.size}x${s.size} (${s.ships} schepen)`;
      b.addEventListener("click", async ()=>{
        const code=Math.random().toString(36).substring(2,7).toUpperCase();
        await set(ref(db,"lobbies/"+code),{
          host: username,
          guest:"",
          mode:mode,
          size:s.size,
          ships:s.ships,
          ready:{}
        });
        localStorage.setItem("lobbyCode",code);
        showLobbyScreen(code);
      });
      sizeSelection.appendChild(b);
    });
  });
});

// Join Lobby
joinLobbyConfirmBtn.addEventListener("click", async ()=>{
  const code = lobbyCodeInput.value.trim().toUpperCase();
  const lobbyRef = ref(db,"lobbies/"+code);
  const snap = await get(lobbyRef);
  if(!snap.exists()){ alert("Lobby niet gevonden!"); return; }
  const data = snap.val();
  if(data.guest){ alert("Lobby vol!"); return; }
  await update(lobbyRef, {guest: username});
  localStorage.setItem("lobbyCode",code);
  showLobbyScreen(code);
});

// Lobby scherm tonen
function showLobbyScreen(code){
  createLobbySection.style.display="none";
  joinLobbySection.style.display="none";
  lobbyScreen.style.display="block";
  lobbyCodeDisplay.textContent=code;
  playerNameSpan.textContent=username;

  const lobbyRef = ref(db,"lobbies/"+code);
  onValue(lobbyRef, snap=>{
    const data = snap.val();
    const opp = (data.host===username)?data.guest:data.host;
    opponentNameSpan.textContent = (opp || "Wachten...") + ((data.ready?.[opp])?" ✅":" ❌");
    playerNameSpan.textContent=username + (data.ready?.[username]?" ✅":" ❌");

    if(data.ready?.[username] && data.ready?.[opp]){
      window.location.href="game.html";
    }
  });
}

// Klaar knop
readyBtn.addEventListener("click", async ()=>{
  const code = localStorage.getItem("lobbyCode");
  const lobbyRef = ref(db,"lobbies/"+code+"/ready");
  await update(lobbyRef, {[username]:true});
  readyBtn.disabled=true;
});
</script>
</body>
</html>
