<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Zeeslag - Lobby</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<div class="container">
  <h1>⚓ Lobby ⚓</h1>
  <p id="lobbyCodeDisplay"></p>
  <p id="status">Wachten op tegenstander...</p>
</div>

<script type="module">
import { db, ref, onValue, update } from "./firebase.js";

const username = localStorage.getItem("username");
const lobbyCode = localStorage.getItem("lobbyCode");
if(!username || !lobbyCode) window.location.href="index.html";

const lobbyRef = ref(db,"lobbies/"+lobbyCode);
const lobbyCodeDisplay = document.getElementById("lobbyCodeDisplay");
const status = document.getElementById("status");

lobbyCodeDisplay.textContent = "Lobby code: " + lobbyCode;

onValue(lobbyRef, async snapshot=>{
  const data = snapshot.val();
  if(!data) { alert("Lobby niet gevonden!"); window.location.href="home.html"; return; }

  const isGuest = localStorage.getItem("isGuest") === "true";

  // Host view
  if(data.host === username && data.guest==="") {
    status.textContent="Wachten op tegenstander...";
  } else if(data.host === username && data.guest!=="") {
    status.textContent=`Tegenstander ${data.guest} verbonden! Start spel...`;

    // Alleen echte spelers worden in games DB opgeslagen
    if(!isGuest){
      await update(ref(db,"games/"+lobbyCode),{
        [username]: {ships:[], shots:[]},
        [data.guest]: {ships:[], shots:[]}
      });
    }

    await update(lobbyRef,{gameStarted:true});
    setTimeout(()=> window.location.href="game.html",1000);
  }

  // Guest view
  if(data.guest === username){
    status.textContent="Verbonden met host! Start spel...";
    setTimeout(()=> window.location.href="game.html",1000);
  }
});
</script>
</body>
</html>
